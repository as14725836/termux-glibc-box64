name: Build Box64 (aarch64)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡ä¸Šæ¸¸æ˜¯å¦æœ‰æ›´æ–°ï¼ˆç›¸å½“äºæºç æ›´æ–°å³åˆ»æ„å»ºï¼‰

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

env:
  SRC_REPO: https://github.com/ptitSeb/box64
  LAST_COMMIT_FILE: last_box64_commit.txt

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ”¹ æ£€å‡ºå½“å‰ä»“åº“ï¼ˆå­˜å‚¨ last commit æ–‡ä»¶ï¼‰
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        
      - name: ä¿®å¤ä¾èµ–
        run: |
          sudo apt clean
          sudo apt autoclean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt update
          sudo rm /var/lib/apt/lists/lock
          sudo rm /var/cache/apt/archives/lock


      # ğŸ”¹ å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc git patchelf jq curl unzip

      # ğŸ”¹ è·å– Box64 æœ€æ–°æäº¤ä¸æ ‡ç­¾
      - name: è·å– Box64 æœ€æ–°æäº¤ä¸æ ‡ç­¾
        id: get_latest
        run: |
          set -e
          echo "ğŸ“¡ æ£€æŸ¥ä¸Šæ¸¸ä»“åº“: $SRC_REPO"
          LATEST_COMMIT=$(git ls-remote $SRC_REPO HEAD | awk '{print $1}')
          LATEST_TAG=$(git ls-remote --tags $SRC_REPO | awk '{print $2}' | sed 's|refs/tags/||' | sort -V | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            echo "âŒ æœªè·å–åˆ°æ ‡ç­¾ï¼Œä½¿ç”¨ commit ç¼©å†™ä½œä¸ºç‰ˆæœ¬"
            LATEST_TAG=${LATEST_COMMIT:0:7}
          fi
          echo "âœ… æœ€æ–°æ ‡ç­¾: $LATEST_TAG"
          echo "âœ… æœ€æ–°æäº¤: $LATEST_COMMIT"
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          curl -s "https://api.github.com/repos/ptitSeb/box64/commits/$LATEST_COMMIT" -o commit.json
          COMMIT_DATE=$(jq -r '.commit.author.date' commit.json)
          COMMIT_AUTHOR=$(jq -r '.commit.author.name' commit.json)
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_ENV
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_ENV

      # ğŸ”¹ è·å–ä¸Šæ¬¡æ„å»ºæäº¤
      - name: è·å–ä¸Šæ¬¡æ„å»ºæäº¤
        id: get_last
        run: |
          if [ -f "${{ env.LAST_COMMIT_FILE }}" ]; then
            LAST_COMMIT=$(cat "${{ env.LAST_COMMIT_FILE }}")
            echo "ä¸Šæ¬¡æ„å»ºæäº¤: $LAST_COMMIT"
          else
            LAST_COMMIT="none"
            echo "æœªæ‰¾åˆ°ä¸Šæ¬¡æ„å»ºè®°å½•"
          fi
          echo "LAST_COMMIT=$LAST_COMMIT" >> $GITHUB_ENV

      # ğŸ”¹ åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
        id: check_build
        run: |
          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "âœ… æ— æ–°æäº¤ï¼Œè·³è¿‡æ„å»º"
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŸ¢ å‘ç°æ–°æäº¤æˆ–æ ‡ç­¾å˜åŒ–ï¼Œå‡†å¤‡æ„å»º..."
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      # ğŸ”¹ è·³è¿‡æ— æ›´æ–°æ„å»º
      - name: è·³è¿‡æ— æ›´æ–°æ„å»º
        if: steps.check_build.outputs.skip_build == 'true'
        run: |
          echo "âœ… æ— æ–°æäº¤ï¼Œè·³è¿‡æ„å»º"
          exit 0

      # ğŸ”¹ å…‹éš† Box64 å¹¶æ„å»º
      - name: å…‹éš† Box64 å¹¶æ„å»º
        if: steps.check_build.outputs.skip_build == 'false'
        run: |
          git clone --depth=1 $SRC_REPO
          cd box64
          mkdir build && cd build
          cmake .. \
            -DARM_DYNAREC=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DARM64=ON \
            -DBAD_SIGN=ON \
            -DSD8G2=ON
          make -j$(nproc)
          echo "âœ… æ„å»ºå®Œæˆ"
          # ä¿®å¤åŠ¨æ€é“¾æ¥å™¨è·¯å¾„ï¼ˆTermux glibcï¼‰
          patchelf --set-interpreter /data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1 box64 || true
          # æ‰“åŒ…
          TAR_FILE="termux-glibc-box64-${LATEST_TAG}.tar.gz"
          tar -czvf ../../$TAR_FILE box64
          echo "$LATEST_COMMIT" > ../../${{ env.LAST_COMMIT_FILE}}
          echo "TAR_FILE=$TAR_FILE" >> $GITHUB_ENV
          echo "VERSION=$LATEST_TAG" >> $GITHUB_ENV

      # ğŸ”¹ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: termux-glibc-box64-${{ env.VERSION }}
          path: ${{ env.TAR_FILE }}

      # ğŸ”¹ ä¿å­˜ last commit æ–‡ä»¶ï¼ˆä¸æ¨é€ä»“åº“ï¼Œåªä¿ç•™ artifactï¼‰
      - name: ä¿å­˜ last commit æ–‡ä»¶
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-box64-commit
          path: ${{ env.LAST_COMMIT_FILE }}

      # ğŸ”¹ å‘å¸ƒ Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: box64-${{ env.VERSION }}
          name: Box64 ${{ env.VERSION }} (aarch64, Termux glibc)
          body: |
            âœ… **Box64 è‡ªåŠ¨æ„å»ºæˆåŠŸï¼**
            - æ ‡ç­¾: `${{ env.VERSION }}`
            - æäº¤å“ˆå¸Œ: `${{ env.LATEST_COMMIT }}`
            - ä½œè€…: `${{ env.commit_author }}`
            - æäº¤æ—¶é—´: `${{ env.commit_date }}`
          files: ${{ env.TAR_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
