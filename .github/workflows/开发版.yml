name: å¼€å‘ç‰ˆ Box64 (aarch64)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

env:
  SRC_REPO: https://github.com/ptitSeb/box64

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ”¹ æ£€å‡ºå½“å‰ä»“åº“
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        
      # ğŸ”¹ ä¿®å¤ä¾èµ–
      - name: ä¿®å¤ä¾èµ–
        run: |
          sudo apt clean
          sudo apt autoclean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt update
          sudo rm /var/lib/apt/lists/lock
          sudo rm /var/cache/apt/archives/lock
      
      # ğŸ”¹ å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc git patchelf jq curl unzip
        
      # ğŸ”¹ è·å– Box64 ä¿¡æ¯
      - name: è·å– Box64 ä¿¡æ¯
        id: get_info
        run: |
          # è·å–æœ€æ–° commit
          LATEST_COMMIT=$(git ls-remote ${{ env.SRC_REPO }} HEAD | cut -f1 | head -c 8)
          
          # è·å–å½“å‰æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·
          CURRENT_DATE=$(date +%Y%m%d%H%M)
          VERSION="dev-${CURRENT_DATE}-${LATEST_COMMIT}"
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "æ„å»ºç‰ˆæœ¬: $VERSION"
          
      # ğŸ”¹ å…‹éš† Box64 å¹¶æ„å»º
      - name: å…‹éš† Box64 å¹¶æ„å»º
        run: |
          # æ¸…ç†æ—§ç›®å½•
          rm -rf box64 box64-build
          
          # å…‹éš†æœ€æ–°æºç 
          git clone --depth=1 https://github.com/ptitSeb/box64.git
          
          cd box64
          mkdir build && cd build
          
          # CMake é…ç½®
          cmake .. \
            -DARM_DYNAREC=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DARM64=ON \
            -DBAD_SIGN=ON \
            -DTERMUX=ON \
            -DSD8G2=ON
          
          # ç¼–è¯‘
          make -j$(nproc)
          echo "âœ… æ„å»ºå®Œæˆ"
          
          # ä¿®å¤åŠ¨æ€é“¾æ¥å™¨è·¯å¾„ï¼ˆTermux glibcï¼‰
          patchelf --set-interpreter /data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1 box64 || true
          
          # æ‰“åŒ…
          TAR_FILE="termux-glibc-box64-${{ env.VERSION }}.tar.gz"
          tar -czvf ../../$TAR_FILE box64
          
          # ç§»åŠ¨æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
          mv ../../$TAR_FILE ../
          echo "TAR_FILE=$TAR_FILE" >> $GITHUB_ENV
          
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ: $TAR_FILE"
      
      # ğŸ”¹ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: box64-${{ env.VERSION }}
          path: box64/${{ env.TAR_FILE }}
          retention-days: 7  # ä¿ç•™7å¤©

      # ğŸ”¹ å‘å¸ƒ Release
      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: box64-${{ env.VERSION }}
          name: Box64 ${{ env.VERSION }} (aarch64, Termux glibc)
          body: |
            ğŸš€ **Box64 è‡ªåŠ¨æ„å»º - å¼€å‘ç‰ˆ**
            
            ### ğŸ“… æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬**: `${{ env.VERSION }}`
            - **Commit**: `${{ env.LATEST_COMMIT }}`
            - **æ„å»ºæ—¶é—´**: `$(date -u +"%Y-%m-%d %H:%M:%S UTC")`
            - **å¹³å°**: `aarch64`
            - **ç¯å¢ƒ**: `Termux glibc`
            
            ### âš™ï¸ ç¼–è¯‘é€‰é¡¹
            - `ARM_DYNAREC=ON`
            - `WINLATOR_GLIBC=ON`
            - `ARM64=ON`
            - `BAD_SIGN=ON`
            - `SD8G2=ON`
            
            ### ğŸ“¦ ä½¿ç”¨è¯´æ˜
            1. è§£å‹æ–‡ä»¶
            2. å°† `box64` å¯æ‰§è¡Œæ–‡ä»¶å¤åˆ¶åˆ° Termux çš„ glibc ç¯å¢ƒä¸­
            3. ç¡®ä¿åŠ¨æ€é“¾æ¥å™¨è·¯å¾„æ­£ç¡®
            
            > âš ï¸ **æ³¨æ„**: è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„å¼€å‘ç‰ˆï¼Œå¯èƒ½ä¸ç¨³å®š
          files: box64/${{ env.TAR_FILE }}
          draft: false
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
