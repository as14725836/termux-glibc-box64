name: å¼€å‘ç‰ˆ Box64 (aarch64)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡ä¸Šæ¸¸æ˜¯å¦æœ‰æ›´æ–°ï¼ˆç›¸å½“äºæºç æ›´æ–°å³åˆ»æ„å»ºï¼‰

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

env:
  SRC_REPO: https://github.com/ptitSeb/box64
  LAST_COMMIT_FILE: last_box64_commit.txt

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ”¹ æ£€å‡ºå½“å‰ä»“åº“ï¼ˆå­˜å‚¨ last commit æ–‡ä»¶ï¼‰
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        
      - name: ä¿®å¤ä¾èµ–
        run: |
          sudo apt clean
          sudo apt autoclean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt update
          sudo rm /var/lib/apt/lists/lock
          sudo rm /var/cache/apt/archives/lock
      # ğŸ”¹ å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc git patchelf jq curl unzip
        
      # ğŸ”¹ å…‹éš† Box64 å¹¶æ„å»º
      - name: å…‹éš† Box64 å¹¶æ„å»º
        run: |
          git clone https://github.com/ptitSeb/box64.git
          cd box64
          mkdir build && cd build
          cmake .. \
            -DARM_DYNAREC=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DWINLATOR_GLIBC=ON \
            -DARM64=ON \
            -DBAD_SIGN=ON \
            -DSD8G2=ON
          make -j$(nproc)
          echo "âœ… æ„å»ºå®Œæˆ"
          # ä¿®å¤åŠ¨æ€é“¾æ¥å™¨è·¯å¾„ï¼ˆTermux glibcï¼‰
          patchelf --set-interpreter /data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1 box64 || true
          # æ‰“åŒ…
          TAR_FILE="termux-glibc-box64-${LATEST_TAG}.tar.gz"
          tar -czvf ../../$TAR_FILE box64
          echo "$LATEST_COMMIT" > ../../${{ env.LAST_COMMIT_FILE}}
          echo "TAR_FILE=$TAR_FILE" >> $GITHUB_ENV
          echo "VERSION=$LATEST_TAG" >> $GITHUB_ENV
      # ğŸ”¹ ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: termux-glibc-box64-${{ env.VERSION }}
          path: ${{ env.TAR_FILE }}

      # ğŸ”¹ ä¿å­˜ last commit æ–‡ä»¶ï¼ˆä¸æ¨é€ä»“åº“ï¼Œåªä¿ç•™ artifactï¼‰
      - name: ä¿å­˜ last commit æ–‡ä»¶
        if: steps.check_build.outputs.skip_build == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: last-box64-commit
          path: ${{ env.LAST_COMMIT_FILE }}

      # ğŸ”¹ å‘å¸ƒ Release
      - name: å‘å¸ƒåˆ° GitHub Release
        if: steps.check_build.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: box64-${{ env.VERSION }}
          name: Box64 ${{ env.VERSION }} (aarch64, Termux glibc)
          body: |
            âœ… **Box64 è‡ªåŠ¨æ„å»ºæˆåŠŸï¼**
            - æ ‡ç­¾: `${{ env.VERSION }}`
            - æäº¤å“ˆå¸Œ: `${{ env.LATEST_COMMIT }}`
            - ä½œè€…: `${{ env.commit_author }}`
            - æäº¤æ—¶é—´: `${{ env.commit_date }}`
          files: ${{ env.TAR_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
